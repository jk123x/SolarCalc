---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
---

<Layout title="Your Solar Report | SolarMath">
  <div id="report-root">
    <div class="max-w-xl mx-auto px-6 py-20 text-center">
      <div class="text-4xl mb-4">‚è≥</div>
      <p class="text-slate-600">Loading your report...</p>
    </div>
  </div>
</Layout>

<script>
  // @ts-nocheck
  const batteryNames = {
    'none': 'No Battery',
    'sungrow_10': 'Sungrow SBR 10.2kWh',
    'byd_hvs': 'BYD HVS 10.2kWh',
    'tesla_powerwall3': 'Tesla Powerwall 3 (13.5kWh)',
    'sonnen_eco': 'Sonnen Eco 10'
  };

  const batteryInfo = {
    'none': { capacity: 0, degradation: 0, threshold: 0, premium: false, cost: 0, warranty: 0 },
    'sungrow_10': { capacity: 10.2, degradation: 2.5, threshold: 70, premium: false, cost: 10500, warranty: 10 },
    'byd_hvs': { capacity: 10.2, degradation: 2.5, threshold: 70, premium: false, cost: 11000, warranty: 10 },
    'tesla_powerwall3': { capacity: 13.5, degradation: 2.0, threshold: 70, premium: true, cost: 14500, warranty: 10 },
    'sonnen_eco': { capacity: 10.0, degradation: 1.5, threshold: 80, premium: true, cost: 16000, warranty: 15 }
  };

  const stateData = {
    'vic': { 
      name: 'Victoria', 
      sun: 4.2, 
      sunRating: 'moderate',
      electricity: 'high',
      bestFor: 'TOU arbitrage due to high peak rates',
      tip: 'Victoria\'s variable weather makes battery storage particularly valuable ‚Äî you can store excess on sunny days for cloudy stretches.'
    },
    'nsw': { 
      name: 'New South Wales', 
      sun: 4.8, 
      sunRating: 'good',
      electricity: 'high',
      bestFor: 'balanced solar + battery systems',
      tip: 'NSW has strong solar resources and high electricity prices, making most solar configurations profitable.'
    },
    'qld': { 
      name: 'Queensland', 
      sun: 5.1, 
      sunRating: 'excellent',
      electricity: 'moderate',
      bestFor: 'maximizing solar generation',
      tip: 'Queensland\'s abundant sunshine means you\'ll generate more power per panel than southern states ‚Äî consider a slightly smaller system to save upfront costs.'
    },
    'sa': { 
      name: 'South Australia', 
      sun: 4.6, 
      sunRating: 'good',
      electricity: 'very high',
      bestFor: 'self-consumption to avoid expensive grid power',
      tip: 'SA has Australia\'s highest electricity prices. Every kWh you self-consume is worth more here than anywhere else in the country.'
    },
    'wa': { 
      name: 'Western Australia', 
      sun: 5.6, 
      sunRating: 'excellent',
      electricity: 'moderate',
      bestFor: 'large solar arrays with battery backup',
      tip: 'Perth gets more sunshine than almost anywhere in Australia. Combined with the state battery rebate (up to $5,000), this makes WA one of the best places for solar + battery.'
    },
    'tas': { 
      name: 'Tasmania', 
      sun: 3.8, 
      sunRating: 'lower',
      electricity: 'moderate',
      bestFor: 'smaller, efficient systems',
      tip: 'Tasmania receives less sun than mainland states, so ROI timelines are longer. However, Tassie\'s cooler climate means panels operate more efficiently ‚Äî heat reduces output.'
    },
    'nt': { 
      name: 'Northern Territory', 
      sun: 5.8, 
      sunRating: 'excellent',
      electricity: 'high',
      bestFor: 'maximum solar generation + battery storage',
      tip: 'Darwin has Australia\'s highest solar irradiance. Combined with up to $6,000 in state battery rebates, the NT offers exceptional solar economics despite the tropical climate.'
    },
    'act': { 
      name: 'ACT', 
      sun: 4.5, 
      sunRating: 'good',
      electricity: 'moderate',
      bestFor: 'balanced residential systems',
      tip: 'The ACT has strong renewable energy policies and good solar resources. Feed-in tariffs here are relatively stable compared to other jurisdictions.'
    }
  };

  function estimateBatteryReplacementYear(battery) {
    const info = batteryInfo[battery];
    if (!info || info.capacity === 0) return null;
    const years = Math.log(info.threshold / 100) / Math.log(1 - info.degradation / 100);
    return Math.round(years);
  }

  function generateProjectionData(data) {
    // Simplified 25-year projection for visualization
    const systemCost = data.systemSize * 1000; // Rough estimate
    const annualSavings = (data.expectedValue + systemCost) / 25;
    const points = [];
    let cumulative = -systemCost;
    
    for (let year = 0; year <= 25; year++) {
      points.push({ year, value: Math.round(cumulative) });
      cumulative += annualSavings * Math.pow(0.995, year); // Slight degradation
    }
    return points;
  }

  function generateInsights(data) {
    const insights = [];
    const battery = batteryInfo[data.battery] || batteryInfo['none'];
    const state = stateData[data.state] || stateData['vic'];
    
    // State-specific solar insight
    insights.push({
      type: 'location',
      title: `Solar potential in ${state.name}`,
      text: `${state.name} receives ${state.sun} peak sun hours daily (${state.sunRating} for Australia). ${state.tip}`,
      icon: 'üìç'
    });

    // ROI assessment with context
    if (data.expectedValue > 15000) {
      insights.push({ 
        type: 'positive', 
        title: 'Excellent investment opportunity', 
        text: `At $${data.expectedValue.toLocaleString()} expected return, this system would significantly outperform a term deposit or bond investment over the same period. The real return is even better when you factor in electricity price inflation.`,
        icon: '‚úì'
      });
    } else if (data.expectedValue > 5000) {
      insights.push({ 
        type: 'positive', 
        title: 'Solid positive returns', 
        text: `Your projected $${data.expectedValue.toLocaleString()} return represents a reasonable investment. Returns could improve further if electricity prices rise faster than our 4% assumption, or if you increase daytime self-consumption.`,
        icon: '‚úì'
      });
    } else if (data.expectedValue > 0) {
      insights.push({ 
        type: 'neutral', 
        title: 'Marginal but positive returns', 
        text: `This configuration breaks even with a small profit. Consider whether adjustments ‚Äî like TOU pricing, shifting usage to daytime, or waiting for battery prices to drop ‚Äî could improve the economics.`,
        icon: '‚Üí'
      });
    } else {
      insights.push({ 
        type: 'warning', 
        title: 'Returns are marginal or negative', 
        text: `With current settings, this system may not pay for itself within 25 years. See our recommendations below ‚Äî small changes can significantly improve the outcome.`,
        icon: '‚ö†'
      });
    }

    // Battery-specific insights
    if (data.battery !== 'none') {
      // TOU + Battery synergy
      if (data.hasTou) {
        insights.push({ 
          type: 'positive', 
          title: 'Smart battery + TOU strategy', 
          text: `You're set up to buy low, sell high: charge your battery with free solar during the day, then use that stored power during expensive peak hours (typically 3-9pm). This arbitrage is worth roughly $${Math.round((0.52 - 0.08) * battery.capacity * 0.75 * 365)}/year in avoided peak charges.`,
          icon: '‚ö°'
        });
      } else {
        insights.push({ 
          type: 'action', 
          title: 'Unlock your battery\'s full value', 
          text: `Without Time-of-Use pricing, your battery can only save the difference between your flat rate and feed-in tariff (~${Math.round((data.electricityRate - 0.08) * 100)}c/kWh). With TOU, you'd save ~44c/kWh by avoiding peak rates. Contact your retailer about switching ‚Äî it could add $300-500/year to your returns.`,
          icon: 'üí°',
          affiliateLink: null,
          affiliateCta: null
        });
      }

      // Battery choice insight
      if (battery.premium) {
        const cheaperOption = batteryInfo['sungrow_10'];
        const costDiff = battery.cost - cheaperOption.cost;
        const yearsGained = estimateBatteryReplacementYear(data.battery) - estimateBatteryReplacementYear('sungrow_10');
        insights.push({
          type: 'info',
          title: `Premium battery trade-off`,
          text: `You've chosen the ${batteryNames[data.battery]}, which costs $${costDiff.toLocaleString()} more than budget options but lasts ~${yearsGained} years longer before needing replacement. With a ${battery.warranty}-year warranty and ${battery.degradation}% annual degradation, this is the right choice if you value longevity over upfront savings.`,
          icon: 'üîã'
        });
      } else {
        const premiumOption = batteryInfo['sonnen_eco'];
        insights.push({
          type: 'info',
          title: `Budget battery trade-off`,
          text: `The ${batteryNames[data.battery]} offers good value but will likely need replacement around year ${estimateBatteryReplacementYear(data.battery)}. If you want a "set and forget" solution, premium batteries like the Sonnen Eco (${premiumOption.degradation}% degradation, ${premiumOption.warranty}-year warranty) last ~${estimateBatteryReplacementYear('sonnen_eco')} years ‚Äî though they cost $${(premiumOption.cost - battery.cost).toLocaleString()} more.`,
          icon: 'üîã'
        });
      }
    } else {
      // No battery advice
      insights.push({
        type: 'info',
        title: 'Solar-only: simple and effective',
        text: `Going without a battery keeps things simple and reduces upfront costs. You'll export excess solar to the grid for ~8c/kWh. Consider adding a battery in 2-3 years when prices drop further ‚Äî by then you'll have real usage data to right-size it.`,
        icon: '‚òÄÔ∏è'
      });
    }

    // Daytime usage insight with actionable advice
    if (data.daytimeUsagePercent && data.daytimeUsagePercent < 30) {
      insights.push({ 
        type: 'action', 
        title: 'Shift usage to unlock savings', 
        text: `Only ${data.daytimeUsagePercent}% of your power is used when the sun shines. Each 10% you shift to daytime adds $200-400/year. Easy wins: run dishwashers and washing machines mid-morning, charge EVs from 10am-3pm, use timer switches for pool pumps.`,
        icon: '‚è∞',
        affiliateLink: 'https://www.amazon.com.au/s?k=smart+timer+plug&tag=solarmath-20',
        affiliateCta: 'See smart timer plugs on Amazon'
      });
    } else if (data.daytimeUsagePercent && data.daytimeUsagePercent >= 30 && data.daytimeUsagePercent < 50) {
      insights.push({ 
        type: 'neutral', 
        title: 'Average daytime usage', 
        text: `${data.daytimeUsagePercent}% daytime usage is typical for households where people work during the day. If someone works from home, you could push this higher by timing appliances to run mid-day.`,
        icon: '‚è∞'
      });
    } else if (data.daytimeUsagePercent && data.daytimeUsagePercent >= 50) {
      insights.push({ 
        type: 'positive', 
        title: 'Excellent self-consumption profile', 
        text: `At ${data.daytimeUsagePercent}% daytime usage, you're maximizing the value of your solar ‚Äî using power worth 32c/kWh instead of exporting it for 8c. This is ideal, whether from work-from-home arrangements or smart appliance scheduling.`,
        icon: '‚è∞'
      });
    }

    // System size insight
    if (data.roofSize && data.systemSize) {
      const maxPossibleSize = data.roofSize / 6.5;
      const utilization = (data.systemSize / maxPossibleSize) * 100;
      if (utilization < 70 && data.expectedValue > 0) {
        insights.push({
          type: 'info',
          title: 'Room to grow',
          text: `You're using ${utilization.toFixed(0)}% of your roof capacity. If you plan to add an EV, pool heater, or heat pump in future, consider sizing up now ‚Äî adding panels later costs more per watt than doing it upfront.`,
          icon: 'üìê'
        });
      }
    }

    return insights;
  }

  function renderChart(data) {
    const projection = generateProjectionData(data);
    const maxVal = Math.max(...projection.map(p => p.value));
    const minVal = Math.min(...projection.map(p => p.value));
    const range = maxVal - minVal;
    const height = 120;
    const width = 100;
    
    // Find breakeven point
    let breakevenYear = null;
    for (let i = 1; i < projection.length; i++) {
      if (projection[i-1].value < 0 && projection[i].value >= 0) {
        breakevenYear = i;
        break;
      }
    }

    const points = projection.map((p, i) => {
      const x = (i / 25) * width;
      const y = height - ((p.value - minVal) / range) * height;
      return `${x},${y}`;
    }).join(' ');

    const zeroY = height - ((0 - minVal) / range) * height;

    return `
      <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl p-6 mb-8">
        <h3 class="text-sm font-semibold text-slate-600 mb-4">25-Year Value Projection</h3>
        <div class="relative" style="height: ${height + 40}px">
          <svg viewBox="0 0 ${width} ${height + 20}" class="w-full h-full" preserveAspectRatio="none">
            <!-- Zero line -->
            <line x1="0" y1="${zeroY}" x2="${width}" y2="${zeroY}" stroke="#94a3b8" stroke-width="0.5" stroke-dasharray="2,2"/>
            
            <!-- Gradient fill -->
            <defs>
              <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:${data.expectedValue >= 0 ? '#22c55e' : '#f59e0b'};stop-opacity:0.3"/>
                <stop offset="100%" style="stop-color:${data.expectedValue >= 0 ? '#22c55e' : '#f59e0b'};stop-opacity:0"/>
              </linearGradient>
            </defs>
            
            <!-- Area fill -->
            <polygon points="0,${height} ${points} ${width},${height}" fill="url(#chartGradient)"/>
            
            <!-- Line -->
            <polyline points="${points}" fill="none" stroke="${data.expectedValue >= 0 ? '#16a34a' : '#d97706'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            
            <!-- Breakeven marker -->
            ${breakevenYear ? `<circle cx="${(breakevenYear / 25) * width}" cy="${zeroY}" r="3" fill="#2563eb"/>` : ''}
          </svg>
          
          <!-- Labels -->
          <div class="absolute bottom-0 left-0 right-0 flex justify-between text-xs text-slate-400">
            <span>Year 0</span>
            ${breakevenYear ? `<span class="text-blue-600 font-medium">Break-even: Year ${breakevenYear}</span>` : ''}
            <span>Year 25</span>
          </div>
        </div>
        
        <div class="flex justify-between mt-4 pt-4 border-t border-slate-200">
          <div>
            <div class="text-xs text-slate-500">Starting investment</div>
            <div class="text-lg font-bold text-red-600">-$${Math.abs(projection[0].value).toLocaleString()}</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-500">Final value (Year 25)</div>
            <div class="text-lg font-bold ${data.expectedValue >= 0 ? 'text-green-600' : 'text-amber-600'}">+$${projection[25].value.toLocaleString()}</div>
          </div>
        </div>
      </div>
    `;
  }

  function renderEnergyFlow(data) {
    const battery = batteryInfo[data.battery] || batteryInfo['none'];
    const dailyGen = data.systemSize * 4.5; // Rough average
    const daytimeUse = data.dailyUsage * (data.daytimeUsagePercent / 100);
    const directUse = Math.min(dailyGen, daytimeUse);
    const excess = dailyGen - directUse;
    const batteryStore = battery.capacity > 0 ? Math.min(excess * 0.85, battery.capacity * 0.75) : 0;
    const exported = excess - batteryStore;
    
    const total = directUse + batteryStore + exported;
    const directPct = (directUse / total) * 100;
    const batteryPct = (batteryStore / total) * 100;
    const exportPct = (exported / total) * 100;

    return `
      <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl p-6 mb-8">
        <h3 class="text-sm font-semibold text-slate-600 mb-4">Daily Energy Flow (Estimated)</h3>
        
        <div class="flex items-center gap-4 mb-4">
          <div class="text-3xl">‚òÄÔ∏è</div>
          <div class="flex-1">
            <div class="text-2xl font-bold text-amber-600">${dailyGen.toFixed(1)} kWh</div>
            <div class="text-xs text-slate-500">Generated daily</div>
          </div>
        </div>
        
        <!-- Flow bar -->
        <div class="h-8 rounded-full overflow-hidden flex mb-4">
          <div class="bg-green-500 flex items-center justify-center text-white text-xs font-medium" style="width: ${directPct}%">
            ${directPct > 15 ? `${directPct.toFixed(0)}%` : ''}
          </div>
          ${battery.capacity > 0 ? `
          <div class="bg-blue-500 flex items-center justify-center text-white text-xs font-medium" style="width: ${batteryPct}%">
            ${batteryPct > 15 ? `${batteryPct.toFixed(0)}%` : ''}
          </div>
          ` : ''}
          <div class="bg-amber-400 flex items-center justify-center text-white text-xs font-medium" style="width: ${exportPct}%">
            ${exportPct > 15 ? `${exportPct.toFixed(0)}%` : ''}
          </div>
        </div>
        
        <div class="grid grid-cols-3 gap-2 text-center text-xs">
          <div>
            <div class="w-3 h-3 bg-green-500 rounded-full mx-auto mb-1"></div>
            <div class="font-medium text-slate-700">Direct use</div>
            <div class="text-slate-500">${directUse.toFixed(1)} kWh @ 32c</div>
          </div>
          ${battery.capacity > 0 ? `
          <div>
            <div class="w-3 h-3 bg-blue-500 rounded-full mx-auto mb-1"></div>
            <div class="font-medium text-slate-700">Battery</div>
            <div class="text-slate-500">${batteryStore.toFixed(1)} kWh @ ${data.hasTou ? '52c' : '32c'}</div>
          </div>
          ` : '<div></div>'}
          <div>
            <div class="w-3 h-3 bg-amber-400 rounded-full mx-auto mb-1"></div>
            <div class="font-medium text-slate-700">Export</div>
            <div class="text-slate-500">${exported.toFixed(1)} kWh @ 8c</div>
          </div>
        </div>
      </div>
    `;
  }

  function renderReport(data) {
    const battery = batteryInfo[data.battery] || batteryInfo['none'];
    const state = stateData[data.state] || stateData['vic'];
    const insights = generateInsights(data);
    const today = new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
    
    const insightsHtml = insights.map(insight => {
      const colors = {
        positive: { bg: 'bg-green-50', border: 'border-green-200', title: 'text-green-900', text: 'text-green-700' },
        warning: { bg: 'bg-amber-50', border: 'border-amber-200', title: 'text-amber-900', text: 'text-amber-700' },
        action: { bg: 'bg-blue-50', border: 'border-blue-200', title: 'text-blue-900', text: 'text-blue-700' },
        info: { bg: 'bg-slate-50', border: 'border-slate-200', title: 'text-slate-900', text: 'text-slate-600' },
        neutral: { bg: 'bg-slate-50', border: 'border-slate-200', title: 'text-slate-900', text: 'text-slate-600' },
        location: { bg: 'bg-purple-50', border: 'border-purple-200', title: 'text-purple-900', text: 'text-purple-700' }
      };
      const c = colors[insight.type] || colors.info;
      const affiliateHtml = insight.affiliateLink ? `<a href="${insight.affiliateLink}" target="_blank" rel="noopener sponsored" class="inline-flex items-center gap-1 mt-3 text-sm font-medium ${c.title} hover:underline">${insight.affiliateCta} <span>‚Üí</span></a>` : '';
      return `
        <div class="rounded-xl p-5 ${c.bg} border ${c.border}">
          <div class="flex gap-3">
            <div class="text-xl">${insight.icon}</div>
            <div class="flex-1">
              <h3 class="font-bold ${c.title}">${insight.title}</h3>
              <p class="text-sm ${c.text} mt-1">${insight.text}</p>
              ${affiliateHtml}
            </div>
          </div>
        </div>`;
    }).join('');

    let batteryTableHtml = '';
    if (battery.capacity > 0) {
      const rows = [1, 3, 5, 10, 15, 20, 25].map(year => {
        const remainingPercent = Math.pow(1 - battery.degradation / 100, year) * 100;
        const remainingCapacity = battery.capacity * (remainingPercent / 100);
        const needsReplacement = remainingPercent < battery.threshold;
        const inWarranty = year <= battery.warranty;
        return `<tr class="${needsReplacement ? 'bg-amber-50' : ''}">
          <td class="py-2 px-3 text-slate-900">Year ${year}</td>
          <td class="py-2 px-3 text-right text-slate-900">${remainingCapacity.toFixed(1)} kWh</td>
          <td class="py-2 px-3 text-right">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${remainingPercent >= 80 ? 'bg-green-100 text-green-800' : remainingPercent >= 70 ? 'bg-amber-100 text-amber-800' : 'bg-red-100 text-red-800'}">
              ${remainingPercent.toFixed(0)}%
            </span>
          </td>
          <td class="py-2 px-3 text-right text-xs ${inWarranty ? 'text-green-600' : 'text-slate-400'}">${inWarranty ? '‚úì Warranty' : 'Expired'}</td>
        </tr>`;
      }).join('');
      
      batteryTableHtml = `
        <div class="bg-white rounded-2xl border border-slate-200 p-6 mb-8">
          <h3 class="text-lg font-bold text-slate-900 mb-2">üîã Battery Lifecycle</h3>
          <p class="text-sm text-slate-600 mb-4">Your ${batteryNames[data.battery]} (${battery.capacity}kWh) degrades at ${battery.degradation}% per year with a ${battery.warranty}-year warranty.</p>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-slate-200 text-slate-500">
                  <th class="py-2 px-3 text-left font-medium">Year</th>
                  <th class="py-2 px-3 text-right font-medium">Usable Capacity</th>
                  <th class="py-2 px-3 text-right font-medium">Health</th>
                  <th class="py-2 px-3 text-right font-medium">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">${rows}</tbody>
            </table>
          </div>
          <p class="text-xs text-slate-400 mt-4">Replacement typically needed when capacity drops below ${battery.threshold}%. We assume replacement cost is 65% of today's price.</p>
        </div>`;
    }

    return `
    <div class="max-w-3xl mx-auto px-4 py-8 md:px-6 md:py-12">
      <!-- Header -->
      <div class="print:hidden mb-6 flex justify-between items-center">
        <a href="/" class="text-blue-600 hover:underline text-sm flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          Back to Calculator
        </a>
        <button onclick="window.print()" class="bg-slate-900 hover:bg-slate-800 text-white font-medium px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
          Save PDF
        </button>
      </div>

      <!-- Report Title -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-medium mb-4">
          <span>üìç</span> ${state.name} ¬∑ ${data.postcode}
        </div>
        <h1 class="text-3xl md:text-4xl font-black text-slate-900 mb-2">Your Solar Analysis</h1>
        <p class="text-slate-500">25-year financial projection ¬∑ Generated ${today}</p>
      </div>

      <!-- Hero Result -->
      <div class="relative overflow-hidden rounded-3xl p-8 text-white mb-8 ${data.expectedValue >= 0 ? 'bg-gradient-to-br from-emerald-500 via-green-600 to-teal-700' : 'bg-gradient-to-br from-amber-500 via-orange-600 to-red-700'}">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-32 translate-x-32"></div>
        <div class="relative">
          <div class="text-sm font-medium opacity-80 mb-1">Expected Return Over 25 Years</div>
          <div class="text-5xl md:text-6xl font-black mb-3">
            ${data.expectedValue >= 0 ? '+' : ''}$${data.expectedValue.toLocaleString()}
          </div>
          <p class="text-white/80 max-w-md">
            ${data.expectedValue >= 10000 
              ? 'This is a strong investment ‚Äî your system should comfortably pay for itself and generate significant returns.' 
              : data.expectedValue > 0 
                ? 'Your system is projected to pay for itself and generate positive returns over its lifetime.'
                : 'With current settings, returns are marginal. See our recommendations to improve the economics.'}
          </p>
        </div>
      </div>

      <!-- Key Metrics -->
      <div class="grid grid-cols-3 gap-3 mb-8">
        <div class="bg-white rounded-2xl border border-slate-200 p-4 text-center">
          <div class="text-3xl font-black text-slate-900">${data.paybackYears}</div>
          <div class="text-xs text-slate-500 mt-1">Years to payback</div>
        </div>
        <div class="bg-white rounded-2xl border border-slate-200 p-4 text-center">
          <div class="text-3xl font-black text-slate-900">${data.systemSize}<span class="text-lg">kW</span></div>
          <div class="text-xs text-slate-500 mt-1">System size</div>
        </div>
        <div class="bg-white rounded-2xl border border-slate-200 p-4 text-center">
          <div class="text-3xl font-black ${data.expectedValue >= 0 ? 'text-green-600' : 'text-red-600'}">${((data.expectedValue / (data.systemSize * 1000)) * 100).toFixed(0)}%</div>
          <div class="text-xs text-slate-500 mt-1">Total ROI</div>
        </div>
      </div>

      <!-- Charts -->
      ${renderChart(data)}
      ${renderEnergyFlow(data)}

      <!-- System Config Summary -->
      <div class="bg-white rounded-2xl border border-slate-200 p-6 mb-8">
        <h3 class="text-lg font-bold text-slate-900 mb-4">‚öôÔ∏è Your Configuration</h3>
        <div class="grid md:grid-cols-2 gap-x-8 gap-y-3">
          <div class="flex justify-between py-2 border-b border-slate-100">
            <span class="text-slate-500">Location</span>
            <span class="font-medium text-slate-900">${data.postcode}, ${state.name}</span>
          </div>
          <div class="flex justify-between py-2 border-b border-slate-100">
            <span class="text-slate-500">Daily usage</span>
            <span class="font-medium text-slate-900">${data.dailyUsage} kWh</span>
          </div>
          <div class="flex justify-between py-2 border-b border-slate-100">
            <span class="text-slate-500">Electricity rate</span>
            <span class="font-medium text-slate-900">${(data.electricityRate * 100).toFixed(0)}c/kWh</span>
          </div>
          <div class="flex justify-between py-2 border-b border-slate-100">
            <span class="text-slate-500">Time-of-Use pricing</span>
            <span class="font-medium ${data.hasTou ? 'text-green-600' : 'text-slate-900'}">${data.hasTou ? 'Yes ‚úì' : 'No'}</span>
          </div>
          <div class="flex justify-between py-2 border-b border-slate-100">
            <span class="text-slate-500">Battery</span>
            <span class="font-medium text-slate-900">${batteryNames[data.battery] || 'None'}</span>
          </div>
          <div class="flex justify-between py-2 border-b border-slate-100">
            <span class="text-slate-500">Daytime usage</span>
            <span class="font-medium text-slate-900">${data.daytimeUsagePercent}%</span>
          </div>
        </div>
      </div>

      <!-- Personalised Insights -->
      <div class="mb-8">
        <h3 class="text-lg font-bold text-slate-900 mb-4">üéØ Personalised Analysis</h3>
        <div class="space-y-4">${insightsHtml}</div>
      </div>

      <!-- Battery Table -->
      ${batteryTableHtml}

      <!-- What's Modeled -->
      <div class="bg-slate-50 rounded-2xl p-6 mb-8">
        <h3 class="text-lg font-bold text-slate-900 mb-4">üìä Methodology</h3>
        <div class="grid md:grid-cols-2 gap-6 text-sm">
          <div>
            <h4 class="font-semibold text-slate-700 mb-2">Included in analysis</h4>
            <ul class="space-y-1 text-slate-600">
              <li class="flex items-start gap-2"><span class="text-green-500 mt-0.5">‚úì</span> Panel degradation (0.5%/year)</li>
              <li class="flex items-start gap-2"><span class="text-green-500 mt-0.5">‚úì</span> Inverter replacement (year 12)</li>
              <li class="flex items-start gap-2"><span class="text-green-500 mt-0.5">‚úì</span> Annual maintenance ($120/year)</li>
              <li class="flex items-start gap-2"><span class="text-green-500 mt-0.5">‚úì</span> Electricity inflation (4%/year)</li>
              <li class="flex items-start gap-2"><span class="text-green-500 mt-0.5">‚úì</span> Federal & state rebates</li>
              <li class="flex items-start gap-2"><span class="text-green-500 mt-0.5">‚úì</span> Discount rate (6%)</li>
              ${battery.capacity > 0 ? '<li class="flex items-start gap-2"><span class="text-green-500 mt-0.5">‚úì</span> Battery degradation & replacement</li>' : ''}
            </ul>
          </div>
          <div>
            <h4 class="font-semibold text-slate-700 mb-2">Not included (upside potential)</h4>
            <ul class="space-y-1 text-slate-600">
              <li class="flex items-start gap-2"><span class="text-slate-400 mt-0.5">‚óã</span> Property value increase (+3-4%)</li>
              <li class="flex items-start gap-2"><span class="text-slate-400 mt-0.5">‚óã</span> Blackout protection value</li>
              <li class="flex items-start gap-2"><span class="text-slate-400 mt-0.5">‚óã</span> Carbon offset value</li>
              <li class="flex items-start gap-2"><span class="text-slate-400 mt-0.5">‚óã</span> EV charging optimization</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Next Steps -->
      <div class="bg-blue-600 rounded-2xl p-6 text-white mb-8">
        <h3 class="text-lg font-bold mb-4">üìã Your Next Steps</h3>
        <ol class="space-y-4">
          <li class="flex gap-4">
            <span class="flex-shrink-0 w-7 h-7 bg-white/20 rounded-full flex items-center justify-center text-sm font-bold">1</span>
            <div>
              <div class="font-semibold">Get 3+ installer quotes</div>
              <div class="text-sm text-blue-100">Prices vary 20-40% between installers. Use SolarQuotes or EnergyEasy to compare CEC-accredited options.</div>
            </div>
          </li>
          <li class="flex gap-4">
            <span class="flex-shrink-0 w-7 h-7 bg-white/20 rounded-full flex items-center justify-center text-sm font-bold">2</span>
            <div>
              <div class="font-semibold">Analyse your usage data</div>
              <div class="text-sm text-blue-100">Download your smart meter data from your retailer's app. An <a href="https://www.amazon.com.au/s?k=home+energy+monitor&tag=solarmath-20" target="_blank" rel="noopener sponsored" class="underline">energy monitor</a> gives real-time visibility.</div>
            </div>
          </li>
          <li class="flex gap-4">
            <span class="flex-shrink-0 w-7 h-7 bg-white/20 rounded-full flex items-center justify-center text-sm font-bold">3</span>
            <div>
              <div class="font-semibold">Confirm rebate eligibility</div>
              <div class="text-sm text-blue-100">Federal battery rebates are first-come-first-served. Check current availability before committing.</div>
            </div>
          </li>
          ${!data.hasTou && data.battery !== 'none' ? `
          <li class="flex gap-4">
            <span class="flex-shrink-0 w-7 h-7 bg-amber-400 text-amber-900 rounded-full flex items-center justify-center text-sm font-bold">!</span>
            <div>
              <div class="font-semibold">Switch to Time-of-Use pricing</div>
              <div class="text-sm text-blue-100">This is critical for battery ROI. Contact your retailer before finalizing your system.</div>
            </div>
          </li>
          ` : ''}
        </ol>
      </div>

      <!-- Footer -->
      <div class="text-center text-xs text-slate-400 border-t border-slate-200 pt-6">
        <p class="mb-2"><strong>Disclaimer:</strong> This analysis is based on modeled scenarios and publicly available data. Actual results depend on weather, usage patterns, electricity prices, and installer costs. This is general information, not financial advice.</p>
        <p class="mb-2">As an Amazon Associate, SolarMath earns from qualifying purchases.</p>
        <p>Generated by <a href="https://solarmath.com.au" class="underline">SolarMath</a> ‚Äî honest solar calculations</p>
      </div>
    </div>`;
  }

  const params = new URLSearchParams(window.location.search);
  const dataParam = params.get('data');
  const root = document.getElementById('report-root');
  
  if (dataParam && root) {
    try {
      const data = JSON.parse(decodeURIComponent(dataParam));
      root.innerHTML = renderReport(data);
    } catch (e) {
      console.error('Parse error:', e);
      root.innerHTML = `
        <div class="max-w-xl mx-auto px-6 py-20 text-center">
          <div class="text-6xl mb-6">ü§î</div>
          <h1 class="text-3xl font-black text-slate-900 mb-4">Something went wrong</h1>
          <p class="text-slate-600 mb-8">We couldn't load your report data.</p>
          <a href="/" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold px-8 py-4 rounded-xl transition">Back to Calculator</a>
        </div>`;
    }
  }
</script>

<style>
  @media print {
    body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
  }
</style>